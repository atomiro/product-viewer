function CameraDollyControl(camera,meshes,rendererElement,options){function init(){$.extend(settings,options),self.panLockAt=Math.abs(settings.maxZoomDistance)-3,rendererElement.dblclick(onDblClick),rendererElement.mousemove(onMouseMove),rendererElement.mousedown(onMouseDown),rendererElement.mouseup(onMouseUp),rendererElement.hover(onHoverIn,onHoverOut);_.debounce(onMouseWheel,10,{leading:!0});$(window).on("mousewheel",onMouseWheel),rendererElement[0].addEventListener("touchmove",onTouchMove,!1),rendererElement[0].addEventListener("touchend",onTouchEnd,!1)}function onDblClick(event){autoZoom()}function onTouchEnd(event){var delay=300,delta=lastTouchTime?event.timeStamp-lastTouchTime:0;console.log(event.changedTouches),1==event.changedTouches.length&&delta<delay&&delta>30&&(event.preventDefault(),autoZoom()),lastTouchTime=event.timeStamp}function autoZoom(){isAnimating=!0;var zoomThreshold=Math.abs(settings.maxZoomDistance-settings.minZoomDistance/2);Math.abs(camera.position.x)>zoomThreshold?0==progress&&(zoomingOut=!1):0==progress&&(zoomingOut=!0)}function onMouseDown(event){mouseDown=!0}function onMouseUp(event){mouseDown=!1}function onHoverIn(event){mouseIn=!0}function onHoverOut(event){mouseIn=!1}function onMouseMove(event){if(Math.abs(cameraDist)<self.panLockAt){var delta=getMouseMoveDelta(event);Math.abs(delta[1])>Math.abs(delta[0])&&pan(delta[1],mousePanSpeedFactor)}}function onMouseWheel(event){if(mouseIn){isAnimating=!1,event.preventDefault();var deltaY=ControlUtils.clamp(event.originalEvent.deltaY,-100,100);interactiveZoom(deltaY,.2)}}function onTouchMove(event){event.preventDefault(),1==event.touches.length?Math.abs(cameraDist)<self.panLockAt&&"VERTICAL"==touchTracker.direction&&pan(touchTracker.speedY,touchPanSpeedFactor):2==event.touches.length&&(isAnimating=!1,interactiveZoom(touchTracker.deltaDistance,.5))}function interactiveZoom(speed,factor){cameraDist+=speed*factor,constrainZoom(settings.minZoomDistance,settings.maxZoomDistance),camera.position.x=cameraDist,centerCamera()}function pan(speed,factor){cameraHeight-=speed*factor,constrainVerticalPan(settings.minCameraHeight,settings.maxCameraHeight),camera.position.y=cameraHeight,camera.lookAt(new THREE.Vector3(0,cameraHeight,0))}function centerCamera(){var totalZoomDist=Math.abs(settings.minZoomDistance-settings.maxZoomDistance),zoomLevel=Math.abs(cameraDist-settings.minZoomDistance)/totalZoomDist;cameraHeight=ControlUtils.lerp(cameraHeight,initHeight,zoomLevel),camera.position.y=cameraHeight,camera.lookAt(new THREE.Vector3(0,cameraHeight,0))}function animateZoom(step){isAnimating&&(progress+=step,progress=ControlUtils.clamp(progress,0,1),cameraHeight=ControlUtils.lerp(cameraHeight,initHeight,progress),cameraDist=zoomingOut?ControlUtils.lerp(cameraDist,settings.maxZoomDistance,progress):ControlUtils.lerp(cameraDist,settings.minZoomDistance,progress),camera.position.y=cameraHeight,camera.position.x=cameraDist,camera.lookAt(new THREE.Vector3(0,cameraHeight,0))),progress>=1&&(isAnimating=!1,progress=0)}function constrainZoom(min,max){Math.abs(cameraDist)<Math.abs(min)&&(cameraDist=min),Math.abs(cameraDist)>Math.abs(max)&&(cameraDist=max)}function constrainVerticalPan(min,max){cameraHeight=ControlUtils.clamp(cameraHeight,min,max)}function getMouseMoveDelta(event){var deltaX=0,deltaY=0;return mouseDown&&(deltaX=mouse.x-event.pageX,deltaY=mouse.y-event.pageY),mouse.x=event.pageX,mouse.y=event.pageY,[deltaX,deltaY]}var settings={minZoomDistance:-12,maxZoomDistance:-50,minCameraHeight:2.5,maxCameraHeight:14.5,animationSpeed:.04};this.panLockAt;var lastTouchTime,initHeight=camera.position.y,cameraHeight=camera.position.y,cameraDist=camera.position.x,mouse={x:0,y:0},mouseDown=!1,mouseIn=!1,touchPanSpeedFactor=.4,mousePanSpeedFactor=.035,self=this,touchTracker=new TouchTracker(rendererElement),isAnimating=!1,zoomingOut=!1,progress=0;return init(),this.animate=function(){animateZoom(settings.animationSpeed)},this}function MeshControl(meshes,rendererElement){function init(){rendererElement.mousedown(onMouseDown),rendererElement.mouseup(onMouseUp),rendererElement.mousemove(onMouseMove),rendererElement[0].addEventListener("touchmove",onTouchMove,!1)}function onMouseMove(event){var delta=getMouseMoveDelta(event);if(Math.abs(delta[0])>Math.abs(delta[1])){var deltaX=ControlUtils.clamp(delta[0],-30,30),angle=deltaX*Math.PI/180*self.mouseSpeedFactor;rotateTo(angle)}}function onMouseDown(event){mouseDown=!0}function onMouseUp(event){mouseDown=!1}function onTouchMove(event){event.preventDefault(),1==event.touches.length&&"HORIZONTAL"==touchTracker.direction&&(angle=touchTracker.speedX*self.touchSpeedFactor,rotateTo(angle))}function rotateTo(angle){for(var i=0;i<meshes.length;i++)mesh=meshes[i],mesh.rotateOnAxis(new THREE.Vector3(0,1,0),-angle)}function getMouseMoveDelta(event){var deltaX=0,deltaY=0;return mouseDown&&(deltaX=mouseX-event.pageX,deltaY=mouseY-event.pageY),mouseX=event.pageX,mouseY=event.pageY,[deltaX,deltaY]}this.meshes=meshes,this.mouseSpeedFactor=.8,this.touchSpeedFactor=.35;var mouseX=0,mouseY=0,mouseDown=!1,self=this,touchTracker=new TouchTracker(rendererElement);return init(),this}function TouchTracker(element){function init(){var el=element[0];el.addEventListener("touchstart",onTouchStart,!1),el.addEventListener("touchmove",onTouchMove,!1),el.addEventListener("touchend",onTouchEnd,!1)}function onTouchStart(event){console.log("tracker",posX,posY),startTime=event.timeStamp,1==event.touches.length?(self.deltaX=0,self.deltaY=0,startPosX=event.touches[0].pageX,posX=startPosX,startPosY=event.touches[0].pageY,posY=startPosY):2==event.touches.length&&(currentDistance=touchDistance(event),lastDistance=currentDistance)}function onTouchMove(event){event.preventDefault(),1==event.touches.length?(getTouchMoveDelta(event),detectDirection(),console.log(self.deltaX),self.speedX=self.deltaX/(event.timeStamp-startTime),self.speedY=self.deltaY/(event.timeStamp-startTime)):2==event.touches.length&&(currentDistance=touchDistance(event),self.deltaDistance=currentDistance-lastDistance,lastDistance=currentDistance)}function onTouchEnd(event){self.deltaX=0,self.deltaY=0,self.deltaDistance=0}function getTouchMoveDelta(event){self.deltaX=startPosX-posX,self.deltaY=startPosY-posY,posX=event.touches[0].pageX,posY=event.touches[0].pageY}function touchDistance(event){var dx=event.touches[0].pageX-event.touches[1].pageX,dy=event.touches[0].pageY-event.touches[1].pageY,distance=Math.sqrt(dx*dx+dy*dy);return distance}function detectDirection(){Math.abs(self.deltaY)>Math.abs(self.deltaX)?self.direction="VERTICAL":self.direction="HORIZONTAL"}var startTime,posX=0,posY=0,startPosX=0,startPosY=0;this.deltaX=0,this.deltaY=0,this.speedX=0,this.speedY=0,this.direction="HORIZONTAL";var lastDistance=0,currentDistance=0;this.deltaDistance=0;var self=this;return init(),this.getDeltas=function(event){return getTouchMoveDelta(event),{dx:deltaX,dy:deltaY}},this}function Viewer(textureArray,element,options){function loadScene(){var sceneFile=settings.assetPath+settings.sceneFile,objloader=new THREE.ObjectLoader;objloader.load(sceneFile,setup,function(xhr){console.log("Scene "+sceneFile+" "+Math.round(xhr.loaded/xhr.total*100)+"%")},function(xhr){console.log(xhr)})}function setup(sceneFile){renderer=new THREE.WebGLRenderer({antialias:!0}),renderer.setPixelRatio(DEVICE_PIXEL_RATIO),renderer.setSize(canvasWidth,canvasHeight),rendererElement.append(renderer.domElement),scene=sceneFile,scene.background=new THREE.Color(settings.sceneBackgroundColor);var grid=new THREE.GridHelper(200,50,255,8421504);scene.add(grid),textureManager=new THREE.LoadingManager,textureManager.onError=function(event){console.log("manager error"),console.log(event)},textureManager.onProgress=function(event){console.log("manager progress"),console.log(event)},textureManager.onLoad=function(event){0==initialized&&(setupMeshes(),setupCamera(),render(),event=$.Event("viewer.loaded"),rendererElement.trigger(event),initialized=!0)};for(var i=0;i<textureArray.length;i++)loadTexture(textureArray[i])}function setupCamera(){camera=new THREE.PerspectiveCamera(settings.fov,settings.aspectRatio,CAM_NEAR_PLANE,CAM_FAR_PLANE),camera.position.x=settings.cameraXPosition;var center=.12*meshes[1].geometry.boundingBox.center().y;camera.position.y=center,camera.lookAt(new THREE.Vector3(0,center,0));var cameraSettings={maxZoomDistance:settings.cameraXPosition,maxCameraHeight:.1*meshes[1].geometry.boundingBox.size().y};cameraControl=new CameraDollyControl(camera,meshes,rendererElement,cameraSettings)}function setupMeshes(){for(var i=0;i<scene.children.length;i++)object=scene.children[i],"Mesh"==object.type&&(object.rotation.y=settings.initialRotation*Math.PI/180,meshes.push(object),object.material.map=textures[0],object.geometry.computeBoundingBox());meshes[1].visible=!1,meshes[0].visible=!0;var bbox1=new THREE.BoundingBoxHelper(meshes[0],65280),bbox2=new THREE.BoundingBoxHelper(meshes[1],16711680);bbox1.update(),bbox2.update(),meshControl=new MeshControl(meshes,rendererElement)}function getTextureByName(name){for(var texture,i=0;i<textures.length;i++)textures[i].name==name&&(texture=textures[i]);return texture}function loadTexture(textureFileName){texturePath=settings.assetPath+textureFileName,textureLoader=new THREE.TextureLoader(textureManager),textureLoader.load(texturePath,function(texture){console.log("loader success"),storeTexture(texture,textureFileName)},function(xhr){console.log("Texture "+textureFileName+" "+Math.round(xhr.loaded/xhr.total*100)+"%")},function(xhr){console.log("loader error"),console.log(xhr)})}function storeTexture(texture,filename){texture.name=filename,textures.push(texture)}function updateTexture(texture,mesh){texture.needsUpdate=!0,mesh.material.map=texture}function debounceResize(element){var debounce=_.debounce(resizeRenderer,200,{leading:!0});debounce(element)}function resizeRenderer(element){canvasWidth=rendererElement.width(),canvasHeight=canvasWidth/settings.aspectRatio,renderer.setSize(canvasWidth,canvasHeight),camera.updateProjectionMatrix()}function render(){requestAnimationFrame(render),cameraControl.animate(),renderer.render(scene,camera)}function onMouseDown(event){element.css("cursor","-webkit-grabbing"),element.css("cursor","grabbing")}function onMouseUp(event){mouseDown=!1,element.css("cursor","-webkit-grab"),element.css("cursor","grab")}var settings={assetPath:"assets/",sceneFile:"models_scene.json",fov:23,aspectRatio:.8,cameraXPosition:-35,cameraYPosition:8.5,initialRotation:-90,sceneBackgroundColor:"rgb(100, 100, 100)"};this.create=function(){$.extend(settings,options),loadScene(),$(window).resize(function(){debounceResize(element)}),element.mousedown(onMouseDown),element.mouseup(onMouseUp),element.css("cursor","-webkit-grab"),element.css("cursor","grab")},this.toggleModels=function(){var plusModel=meshes[1],straightModel=meshes[0];1==straightModel.visible?(plusModel.visible=!0,straightModel.visible=!1):(straightModel.visible=!0,plusModel.visible=!1),event=$.Event("viewer.togglemodel"),rendererElement.trigger(event)},this.switchTexture=function(name){for(var i=0;i<scene.children.length;i++)object=scene.children[i],"Mesh"==object.type&&updateTexture(getTextureByName(name),object);event=$.Event("viewer.switchtexture"),rendererElement.trigger(event)},this.addTexture=loadTexture,this.create();var scene,camera,renderer,meshControl,cameraControl,textureManager,initialized=!1,meshes=[],textures=[],rendererElement=element,canvasWidth=rendererElement.width(),canvasHeight=canvasWidth/settings.aspectRatio,DEVICE_PIXEL_RATIO=window.devicePixelRatio?window.devicePixelRatio:1,CAM_FAR_PLANE=1e3,CAM_NEAR_PLANE=.1;return this}var ControlUtils={clamp:function(value,min,max){var clampedValue=value>max?max:value<min?min:value;return clampedValue},lerp:function(p0,p1,progress){ControlUtils.clamp(progress,0,1);var pu=p0+(p1-p0)*progress;return pu}};
//# sourceMappingURL=viewer.min.js.map